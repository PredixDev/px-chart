<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-rangepicker/px-rangepicker.html"/>

<!--
Template element for default time controls on a time series chart

##### Usage

    <px-ts-chart-controls data-controls>
      <button class="btn">My Special button</button>
    </px-ts-chart-controls>

    <px-ts-chart-controls
        data-controls
        show-export="true"
        show-date-range="true">
    </px-ts-chart-controls>

    <px-ts-chart-controls data-controls zoom-buttons='[]'>

    <px-ts-chart-controls
        data-controls
        zoom-buttons='[{"label": "1 m", "value": 1, "unit": "months"},{"label": "3 m", "value": 3, "unit": "months"}]'>
    </px-ts-chart-controls>

@element px-ts-chart-controls
@blurb Template element for default time controls on a time series chart
@demo demo.html
@homepage index.html
-->
<dom-module id="px-ts-chart-controls">
  <link rel="import" type="css" href="css/px-time-series.css"/>
  <template>
    <div>
      <template is="dom-if" if="{{showDateRange}}">
        <px-rangepicker from="{{rangeStartDisplay}}" to="{{rangeEndDisplay}}" class="float--right"></px-rangepicker>
      </template>

      <template is="dom-if" if="{{showExport}}">
        <button class="btn btn--icon u-ml- float--right" on-click="_exportHandler" title="Export chart">
          <i class="fa fa-share-square-o"></i>
        </button>
      </template>
    </div>

    <div class="clearfix"></div>

    <template is="dom-if" if="{{hasZoomButtons}}">
      <p class="u-mb+ float--right">
        <span class="u-mr-">Zoom</span>
        <span>
          <template is="dom-repeat" items="[[zoomButtons]]">
            <button on-click="_setRangeFromPresent" data-time-value$="[[item.value]]" data-unit$="[[item.unit]]" class="btn">[[item.label]]</button>
          </template>
        </span>
      </p>
    </template>
    <content></content>
  </template>
</dom-module>

<script src="../moment/min/moment.min.js"></script>

<script>
  Polymer({

    is: 'px-ts-chart-controls',

    /**
     * Properties block, expose attribute values to the DOM via 'reflect'
     *
     * @property properties
     * @type Object
     */
    properties: {

      /**
       * Whether to show date range control
       *
       * Can only be statically configured (not data-bindable).
       *
       * @type {Boolean}
       * @default false
       */
      showDateRange: {
        type: Boolean,
        value: false
      },

      /**
       * Whether to show export control
       *
       * Can only be statically configured (not data-bindable).
       *
       * @type {Boolean}
       * @default false
       */
      showExport: {
        type: Boolean,
        value: false
      },

      /**
       * Array of object representing the time zoom buttons.  Each object in the Array has the following members:
       *
       * * "label" {String} The text in the button, e.g. "3 m"
       * * "value" {Number} The time value, e.g. 3
       * * "unit" {String} A momentjs unit string, e.g. "months"
       *
       * Can only be statically configured (not data-bindable).
       *
       * @type {Array}
       * @default [{label: "1 m", value: 1, unit: "months"},{label: "3 m", value: 3, unit: "months"},{label: "6 m", value: 6, unit: "months"},{label: "1 y", value: 1, unit: "year"}]
       */
      zoomButtons: {
        type: Array,
        value: [
          {label: "1 m", value: 1, unit: "months"},
          {label: "3 m", value: 3, unit: "months"},
          {label: "6 m", value: 6, unit: "months"},
          {label: "1 y", value: 1, unit: "year"},
          {label: "YTD", value: Date.now() - moment().startOf("year").valueOf(), unit: "ms"}
        ]
      },

      /**
       * Whether the zoomButtons array is empty
       * @private
       */
      hasZoomButtons: {
        type: Boolean,
        computed: '_zoomButtonsNotEmpty(zoomButtons)'
      },

      /**
       * Start of range in milliseconds since epoch
       * @private
       */
      rangeStartMs: {
        type: Object,
        observer: '_updateRangeStartDisplay'
      },

      /**
       * End of range in milliseconds since epoch
       * @private
       */
      rangeEndMs: {
        type: Object,
        observer: '_updateRangeEndDisplay'
      }

    },

    observers: [
      '_submitRange(rangeStartDisplay, rangeEndDisplay)'
    ],

    _zoomButtonsNotEmpty: function(zoomButtons) {
      return zoomButtons && zoomButtons.length > 0;
    },

    _updateRangeStartDisplay: function() {
      this.rangeStart = moment(this.rangeStartMs, 'x');
      this.set('rangeStartDisplay', this.rangeStart.format('MM/DD/YYYY hh:mm:ss A'));
    },

    _updateRangeEndDisplay: function() {
      this.rangeEnd = moment(this.rangeEndMs, 'x');
      this.set('rangeEndDisplay', this.rangeEnd.format('MM/DD/YYYY hh:mm:ss A'));
    },

    _submitRange: function() {
      var newStartMs = moment(this.rangeStartDisplay, 'MM/DD/YYYY hh:mm:ss A').format('x');
      var newEndMs = moment(this.rangeEndDisplay, 'MM/DD/YYYY hh:mm:ss A').format('x');
      Polymer.dom(this).parentNode.setExtremesIfChanged(newStartMs, newEndMs);
    },

    _setRangeFromPresent: function(evt) {
      var value = evt.target.getAttribute("data-time-value");
      var unit = evt.target.getAttribute("data-unit");

      var now = moment();
      var fromTime = moment(now).subtract(value, unit);

      this.set('rangeStartMs', now.format('x'));
      this.set('rangeEndMs', fromTime.format('x'));
    },

    _exportHandler: function(evt) {
      Polymer.dom(this).parentNode.chart.exportChart();
    }
  });
</script>
