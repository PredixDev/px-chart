<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs
    See https://github.sw.ge.com/jreichenberg/grunt-dep-serve#why-do-we-need-this
-->
<link rel="import" href="../polymer/polymer.html"/>

<!--
Template element for default time controls on a time series chart

##### Usage

    <px-ts-chart-controls>
      <button class="btn">My Sepcial button</button>
    </px-ts-chart-controls>

@element px-ts-chart-controls
@blurb Template element for default time controls on a time series chart
@demo demo.html
@homepage index.html
-->
<dom-module id="px-ts-chart-controls">
  <link rel="import" type="css" href="css/px-time-series.css"/>
  <template>
    <div>
      <template is="dom-if" if="{{showDateRange}}">
        <span>
          <label class="label--inline">From</label>
          <input value="{{rangeStartDisplayStr::change}}" class="text-input input--small" placeholder="HH:MM MM/DD/YYYY"/>

          <label class="label--inline">To</label>
          <input value="{{rangeEndDisplayStr::change}}" class="text-input input--small" placeholder="HH:MM MM/DD/YYYY"/>

          <button on-click="rangeSetHandler" class="btn u-ml-">Submit</button>
        </span>
      </template>

      <!-- Removing refresh button temporarily for MVP2 release -->
      <!--<template is="dom-if" if="{{showRefresh}}">-->
        <!--<button class="btn btn--icon u-ml-" on-click="refreshHandler" title="Refresh chart">-->
          <!--<i class="fa fa-refresh"></i>-->
        <!--</button>-->
      <!--</template>-->

      <template is="dom-if" if="{{showExport}}">
        <button class="btn btn--icon u-ml-" on-click="exportHandler" title="Export chart">
          <i class="fa fa-share-square-o"></i>
        </button>
      </template>
    </div>

    <template is="dom-if" if="{{hasZoomButtons}}">
      <p class="u-mb+">
        <span class="u-mr-">Zoom</span>
        <span>
          <template is="dom-repeat" items="[[zoomButtons]]">
            <button on-click="setRangeFromPresent" data-time-value$="[[item.value]]" data-unit$="[[item.unit]]" class="btn">[[item.label]]</button>
          </template>
        </span>
      </p>
    </template>
    <content></content>
  </template>
</dom-module>

<script src="../moment/min/moment.min.js"></script>

<script>
  Polymer({

    is: 'px-ts-chart-controls',

    /**
     * Properties block, expose attribute values to the DOM via 'reflect'
     *
     * @property properties
     * @type Object
     */
    properties: {

      /**
       * Whether to show date range control
       *
       * @type {Boolean}
       * @default false
       */
      showDateRange: {
        type: Boolean,
        value: false
      },

      /**
       * Whether to show refresh control
       *
       * @type {Boolean}
       * @default false
       */
//      Removing refresh button temporarily for MVP2 release
//      showRefresh: {
//        type: Boolean,
//        value: false
//      },

      /**
       * Whether to show export control
       *
       * @type {Boolean}
       * @default false
       */
      showExport: {
        type: Boolean,
        value: false
      },

      /**
       * Array of object representing the time zoom buttons.  Each object in the Array has the following members:
       *
       * "label" {String} The text in the button, e.g. "3 m"
       * "value" {Number} The time value, e.g. 3
       * "unit" {String} A momentjs unit string, e.g. "months"
       *
       * @type {Array}
       * @default [{label: "1 m", value: 1, unit: "months"},{label: "3 m", value: 3, unit: "months"},{label: "6 m", value: 6, unit: "months"},{label: "1 y", value: 1, unit: "year"},]
       */
      zoomButtons: {
        type: Array,
        value: [
          {label: "1 m", value: 1, unit: "months"},
          {label: "3 m", value: 3, unit: "months"},
          {label: "6 m", value: 6, unit: "months"},
          {label: "1 y", value: 1, unit: "year"},
          {label: "YTD", value: Date.now() - moment().startOf("year").valueOf(), unit: "ms"}
        ]
      },

      /**
       * Whether the zoomButtons array is empty
       */
      hasZoomButtons: {
        type: Boolean,
        computed: '_zoomButtonsNotEmpty(zoomButtons)'
      } ,

      rangeStartDisplayStr: {
        type: String
      },

      rangeEndDisplayStr: {
        type: String
      }

    },

    _showDateRangeHandler: function(newValue, oldValue) {
      console.log(this.className + " show date range= " + newValue + " " + oldValue);
    },

    _zoomButtonsNotEmpty: function(zoomButtons) {
      return zoomButtons && zoomButtons.length > 0;
    },

    /**
     * Sets the range start / end given number of months back from present
     *
     * @param {Event} evt Event with a target that has a data-time-value and data-unit attr or Number of months back from present
     */
    setRangeFromPresent: function (evt) {
      var value = evt.target.getAttribute("data-time-value");
      var unit = evt.target.getAttribute("data-unit");
      Polymer.dom(this).parentNode.setRangeFromPresent(value, unit);
    },

    /**
     * Parses rangeStartDisplayStr and rangeEndDisplayStr and sets actual range based on them
     */
    rangeSetHandler: function () {
      var mStart = moment(this.rangeStartDisplayStr);
      var mEnd = moment(this.rangeEndDisplayStr);
      if (mStart.isValid() && mEnd.isValid()) {
        Polymer.dom(this).parentNode.setExtremesIfChanged(mStart.valueOf(), mEnd.valueOf());
      }
    },

    /**
     * Fires a refresh event on the chart
     *
     * @param {Event} evt
     */
    refreshHandler: function (evt) {
      Polymer.dom(this).parentNode.refreshAllSeries();
    },

    /**
     * Passes export call from the controls to the chart
     *
     * @param {Event} evt
     */
    exportHandler: function (evt) {
      Polymer.dom(this).parentNode.chart.exportChart();
    }
  });
</script>
